name: Publish Helm Charts to Pages

on:
  push:
    branches: [ main ]
    paths:
      - '*/Chart.yaml'
      - '*/values.yaml'
      - '*/templates/**'
      - '*/charts/**'
      - '.github/workflows/helm-gh-pages.yml'
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
      - 'charts/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: gh-pages
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Checkout existing gh-pages (if any)
        id: pages
        uses: actions/checkout@v5
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Package charts and build index
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p repo
          # Bring forward existing repo content (index/tgz) if gh-pages exists
          if [ -d gh-pages ]; then
            shopt -s dotglob nullglob
            cp -a gh-pages/* repo/ || true
            shopt -u dotglob nullglob
          fi
          # Find top-level charts (exclude subcharts)
          mapfile -t charts < <(find . -maxdepth 3 -type f -name Chart.yaml \
            -not -path "./gh-pages/*" -not -path "./.git/*" -not -path "./.github/*" -not -path "*/charts/*")
          if [ "${#charts[@]}" -eq 0 ]; then
            echo "No charts found."
          else
            for chart in "${charts[@]}"; do
              chart_dir="$(dirname "$chart")"
              echo "Packaging $chart_dir"
              helm dependency build "$chart_dir" || true
              helm lint "$chart_dir" || true
              helm package "$chart_dir" --destination repo
            done
          fi
          # Build or merge index.yaml
          REPO_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          if [ -f repo/index.yaml ]; then
            cp repo/index.yaml repo/_old-index.yaml
            helm repo index repo --url "$REPO_URL" --merge repo/_old-index.yaml
            rm -f repo/_old-index.yaml
          else
            helm repo index repo --url "$REPO_URL"
          fi

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: repo
